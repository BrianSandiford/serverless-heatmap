<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Barbados • Towers vs Speed</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .mode-control {
      background: #fff; padding: 6px 8px; border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4); font: 14px/1.2 system-ui, sans-serif;
    }
    .legend {
      background: #fff; padding: 8px; border-radius: 4px;
      line-height: 1.2; box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; opacity: .9; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Map ---
    const map = L.map('map').setView([13.15, -59.55], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // --- Color scales ---
    function colorTowers(v){
      return v > 20 ? '#08306b' :
             v > 10 ? '#2171b5' :
             v >  5 ? '#6baed6' :
             v >  0 ? '#c6dbef' : '#f7fbff';
    }
    // speeds are in kbps; tweak bins as you like
    function colorSpeed(v){
      return v > 50000 ? '#00441b' :
             v > 30000 ? '#1b7837' :
             v > 15000 ? '#5aae61' :
             v >  8000 ? '#a6dba0' :
             v >  4000 ? '#d9f0d3' : '#f7fcf5';
    }

    let currentMode = 'towers'; // 'towers' or 'speed'
    let layer;                  // the GeoJSON layer
    let dataCache;              // keep data around to restyle
    const legend = L.control({position: 'bottomright'});

    // --- Legend builder ---
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      const items = currentMode === 'towers'
        ? [ [">20",21], [">10",11], [">5",6], [">0",1], ["0",0] ]
        : [ [">50 Mbps", 50001], [">30 Mbps",30001], [">15 Mbps",15001], [">8 Mbps",8001], [">4 Mbps",4001], ["≤4 Mbps",0] ];

      div.innerHTML = `<strong>${currentMode==='towers'?'Tower count':'Avg download (kbps)'}</strong><br>`;
      items.forEach(([label,val])=>{
        const color = currentMode==='towers' ? colorTowers(val) : colorSpeed(val);
        div.innerHTML += `<i style="background:${color}"></i>${label}<br>`;
      });
      return div;
    };

    function styleFeature(feat){
      const p = feat.properties;
      const value = currentMode === 'towers' ? (p.towers_all ?? 0) : (p.avg_download_kbps ?? 0);
      const fill = currentMode === 'towers' ? colorTowers(value) : colorSpeed(value);
      return { color: "#333", weight: 0.3, fillOpacity: 0.75, fillColor: fill };
    }

    function popupHtml(p){
      const d = (p.avg_download_kbps ?? 0).toFixed(0);
      const u = (p.avg_upload_kbps ?? 0).toFixed(0);
      return `
        <b>Tile ID:</b> ${p.tile_id}<br/>
        <b>Towers:</b> ${p.towers_all}<br/>
        <b>Avg Download:</b> ${d} kbps<br/>
        <b>Avg Upload:</b> ${u} kbps
      `;
    }

    function renderLayer(geojson){
      if(layer){ layer.remove(); }
      layer = L.geoJSON(geojson, {
        style: styleFeature,
        onEachFeature: (f, l) => l.bindPopup(popupHtml(f.properties))
      }).addTo(map);
      legend.remove(); legend.addTo(map);
    }

    // --- Mode control (dropdown) ---
    const ModeControl = L.Control.extend({
      onAdd: function(){
        const div = L.DomUtil.create('div','mode-control');
        div.innerHTML = `
          <label style="display:block;margin-bottom:4px;"><b>Color by</b></label>
          <select id="modeSelect">
            <option value="towers" selected>Towers</option>
            <option value="speed">Avg Download</option>
          </select>
        `;
        // Prevent map drag when interacting with control
        L.DomEvent.disableClickPropagation(div);
        return div;
      }
    });
    map.addControl(new ModeControl({position:'topleft'}));

    // React to selection change
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id === 'modeSelect'){
        currentMode = e.target.value;
        renderLayer(dataCache);
      }
    });

    // --- Load your GeoJSON (with geometry) ---
    fetch('towers_per_tile.geojson')
      .then(r=>r.json())
      .then(geojson=>{
        dataCache = geojson;
        renderLayer(geojson);
        // zoom to data
        const bounds = L.geoJSON(geojson).getBounds();
        if(bounds.isValid()) map.fitBounds(bounds.pad(0.05));
      })
      .catch(err=>console.error('Failed to load GeoJSON:', err));
  </script>
</body>
</html>
