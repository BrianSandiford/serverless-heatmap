<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Heatmap — Towers & Speed</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // 1) Map init (center roughly on Barbados)
    const map = L.map('map').setView([13.15, -59.55], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2) Helper styles
    function styleByTowers(feature) {
      const n = feature.properties?.towers_all ?? 0;
      // simple choropleth: more towers → darker color
      return {
        color: '#555',
        weight: 0.5,
        fillOpacity: Math.min(0.1 + n * 0.08, 0.8),
        fillColor: n > 10 ? '#08519c' :
                   n > 5  ? '#3182bd' :
                   n > 2  ? '#6baed6' :
                   n > 0  ? '#9ecae1' : '#c6dbef'
      };
    }

    function styleByLTE(feature) {
      const n = feature.properties?.towers_lte ?? 0;
      return {
        color: '#555',
        weight: 0.5,
        fillOpacity: Math.min(0.1 + n * 0.08, 0.8),
        fillColor: n > 10 ? '#006d2c' :
                   n > 5  ? '#2ca25f' :
                   n > 2  ? '#66c2a4' :
                   n > 0  ? '#99d8c9' : '#ccece6'
      };
    }

    function onEachFeature(feature, layer) {
      const p = feature.properties || {};
      const rows = Object.entries(p)
        .map(([k, v]) => `<tr><td><b>${k}</b></td><td>${v}</td></tr>`)
        .join('');
      layer.bindPopup(`<table>${rows}</table>`);
    }

    // 3) Load your ETL outputs (adjust paths if you moved them)
    const towersAllUrl = 'towers_per_tile.geojson';
    const towersLTEUrl = 'towers_per_tile_lte.geojson';

    const baseLayers = {};
    const overlays = {};

    // Towers (all)
    fetch(towersAllUrl)
      .then(r => r.json())
      .then(geo => {
        const layer = L.geoJSON(geo, {
          style: styleByTowers,
          onEachFeature
        }).addTo(map);
        overlays['Towers (All)'] = layer;
      })
      .catch(err => console.error('Failed to load towers_per_tile.geojson', err));

    // Towers (LTE + nearest LTE distance)
    fetch(towersLTEUrl)
      .then(r => r.json())
      .then(geo => {
        const layer = L.geoJSON(geo, {
          style: styleByLTE,
          onEachFeature
        });
        overlays['Towers (LTE)'] = layer;
      })
      .catch(err => console.error('Failed to load towers_per_tile_lte.geojson', err));

    // 4) Add a layer control after both fetches resolve (simple delay works)
    setTimeout(() => {
      L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);
    }, 800);
  </script>
</body>
</html>
