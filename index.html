<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Barbados Connectivity – Towers & LTE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* Popup/legend text look */
    .info {
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Small legend card */
    .legend {
      background: rgba(255,255,255,0.92);
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #333;
    }
    .legend .row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }
    .legend .swatch {
      width: 12px;
      height: 12px;
      border: 1px solid #333;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
  // 1) Map + basemap
  const map = L.map('map').setView([13.16, -59.55], 11);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Helper color scales (adjust breaks/colors to taste)
  function colorByCount(n) {
    // For ALL towers (blue-ish)
    return n > 40 ? '#08306b' :
           n > 30 ? '#08519c' :
           n > 20 ? '#2171b5' :
           n > 10 ? '#4292c6' :
           n >  5 ? '#6baed6' :
                    '#9ecae1';
  }

  function colorByLTE(n) {
    // For LTE towers (green-ish)
    return n > 25 ? '#00441b' :
           n > 18 ? '#006d2c' :
           n > 12 ? '#238b45' :
           n >  6 ? '#41ab5d' :
           n >  2 ? '#74c476' :
                    '#a1d99b';
  }

  // Layer control scaffold (you had this — perfect)
  const baseMaps = { OpenStreetMap: osm };
  const overlays = {};
  const layerControl = L.control.layers(baseMaps, overlays, { collapsed:false }).addTo(map);

  // 2) All Towers (blue)
  let allTowersLayer;
  fetch('towers_per_tile.geojson?v=2')  // cache-bust
    .then(r => r.json())
    .then(data => {
      allTowersLayer = L.geoJSON(data, {
        style: f => ({
          color: '#2b4a7d',                                // darker blue outline
          weight: 0.9,                                     // thin stroke
          fillColor: colorByCount(f.properties?.towers_all ?? 0),
          fillOpacity: 0.58
        }),
        onEachFeature: (f, layer) => {
          const p = f.properties||{};
          layer.bindPopup(
            `<b>Tile:</b> ${p.tile_id ?? '—'}<br>
             <b>Towers:</b> ${p.towers_all ?? 0}<br>
             <b>Down (kbps):</b> ${p.avg_download_kbps ?? '—'}<br>
             <b>Up (kbps):</b> ${p.avg_upload_kbps ?? '—'}`
          );
        }
      }).addTo(map);

      // Register with the existing control
      overlays['All Towers'] = allTowersLayer;
      layerControl.addOverlay(allTowersLayer, 'All Towers');
    });

  // 3) LTE Towers (green) — shown by default
  let lteLayer;
  fetch('towers_per_tile_lte.geojson?v=2')  // cache-bust
    .then(r => r.json())
    .then(data => {
      if (!data.features || !data.features.length) {
        console.warn('LTE GeoJSON has no features');
        return;
      }
      lteLayer = L.geoJSON(data, {
        style: f => ({
          color: '#1e6129',                                // dark green outline
          weight: 1.0,                                     // slightly stronger stroke
          fillColor: colorByLTE(f.properties?.towers_lte ?? 0),
          fillOpacity: 0.58
        }),
        onEachFeature: (f, layer) => {
          const p = f.properties||{};
          layer.bindPopup(
            `<b>Tile:</b> ${p.tile_id ?? '—'}<br>
             <b>LTE Towers:</b> ${p.towers_lte ?? 0}<br>
             <b>Down (kbps):</b> ${p.avg_download_kbps ?? '—'}<br>
             <b>Up (kbps):</b> ${p.avg_upload_kbps ?? '—'}<br>
             <b>Nearest LTE (m):</b> ${p.meters_to_nearest_lte ?? '—'}`
          );
        }
      });

      // Make LTE visible by default:
      lteLayer.addTo(map);

      // Register with the control
      overlays['LTE Towers'] = lteLayer;
      layerControl.addOverlay(lteLayer, 'LTE Towers');
    })
    .catch(err => console.error('Failed to load LTE layer:', err));

  // 4) Tiny legend (bottom-right)
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div style="font-weight:600;margin-bottom:4px;">Choropleth</div>
      <div class="row">
        <span class="swatch" style="background:#08306b"></span>
        <span>All Towers (darker = more)</span>
      </div>
      <div class="row">
        <span class="swatch" style="background:#00441b"></span>
        <span>LTE Towers (darker = more)</span>
      </div>
    `;
    return div;
  };
  legend.addTo(map);
  </script>
</body>
</html>
