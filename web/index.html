<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Barbados Connectivity – Towers & LTE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* Popup/legend text look */
    .info {
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Small legend card */
    .legend {
      background: rgba(255,255,255,0.92);
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #333;
    }
    .legend .row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }
    .legend .swatch {
      width: 12px;
      height: 12px;
      border: 1px solid #333;
      display: inline-block;
    }
    .legend i { width:14px; height:14px; float:left; margin-right:6px; opacity:.8; }

    /* Credits footer: clear, visible, clickable */
    .credits-footer {
      position: fixed;
      left: 10px;
      bottom: 8px;       /* sits just above default Leaflet attribution */
      z-index: 600;
      background: rgba(255,255,255,0.92);
      border-radius: 4px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      padding: 6px 10px;
      font: 12px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #222;
    }
    .credits-footer a { color: #0061c2; text-decoration: none; }
    .credits-footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
  // 1) Map + basemap (keep attribution control enabled)
  const map = L.map('map', { attributionControl: true }).setView([13.16, -59.55], 11);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    // OSM safe-harbour attribution: must be clickable and say “OpenStreetMap contributors”
    attribution: '© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Add specific attributions for other datasets you display
  map.attributionControl.addAttribution(
    'Cell-tower data: <a href="https://opencellid.org/odbl" target="_blank" rel="noopener">OpenCelliD</a> (ODbL)'
  );
  map.attributionControl.addAttribution(
    'Speed data: <a href="https://registry.opendata.aws/speedtest-global-performance/" target="_blank" rel="noopener">Ookla Open Data</a>'
  );

  // Helper color scales (adjust breaks/colors to taste)
  function colorByCount(n) {
    // For ALL towers (blue-ish)
    return n > 40 ? '#08306b' :
           n > 30 ? '#08519c' :
           n > 20 ? '#2171b5' :
           n > 10 ? '#4292c6' :
           n >  5 ? '#6baed6' :
                    '#9ecae1';
  }

  function colorByLTE(n) {
    // For LTE towers (green-ish)
    return n > 25 ? '#00441b' :
           n > 18 ? '#006d2c' :
           n > 12 ? '#238b45' :
           n >  6 ? '#41ab5d' :
           n >  2 ? '#74c476' :
                    '#a1d99b';
  }

  // Layer control scaffold
  const baseMaps = { OpenStreetMap: osm };
  const overlays = {};
  const layerControl = L.control.layers(baseMaps, overlays, { collapsed:false }).addTo(map);

  // 2) All Towers (blue)
  let allTowersLayer;
  fetch('data/towers_per_tile.geojson?v=2')  // cache-bust
    .then(r => r.json())
    .then(data => {
      allTowersLayer = L.geoJSON(data, {
        style: f => ({
          color: '#2b4a7d',
          weight: 0.9,
          fillColor: colorByCount(f.properties?.towers_all ?? 0),
          fillOpacity: 0.58
        }),
        onEachFeature: (f, layer) => {
          const p = f.properties||{};
          layer.bindPopup(
            `<b>Tile:</b> ${p.tile_id ?? '—'}<br>
             <b>Towers:</b> ${p.towers_all ?? 0}<br>
             <b>Down (kbps):</b> ${p.avg_download_kbps ?? '—'}<br>
             <b>Up (kbps):</b> ${p.avg_upload_kbps ?? '—'}`
          );
        }
      }).addTo(map);

      overlays['All Towers'] = allTowersLayer;
      layerControl.addOverlay(allTowersLayer, 'All Towers');
    });

  // 3) LTE Towers (green) — shown by default
  let lteLayer;
  fetch('data/towers_per_tile_lte.geojson?v=2')
    .then(r => r.json())
    .then(data => {
      if (!data.features || !data.features.length) {
        console.warn('LTE GeoJSON has no features');
        return;
      }
      lteLayer = L.geoJSON(data, {
        style: f => ({
          color: '#1e6129',
          weight: 1.0,
          fillColor: colorByLTE(f.properties?.towers_lte ?? 0),
          fillOpacity: 0.58
        }),
        onEachFeature: (f, layer) => {
          const p = f.properties||{};
          layer.bindPopup(
            `<b>Tile:</b> ${p.tile_id ?? '—'}<br>
             <b>LTE Towers:</b> ${p.towers_lte ?? 0}<br>
             <b>Down (kbps):</b> ${p.avg_download_kbps ?? '—'}<br>
             <b>Up (kbps):</b> ${p.avg_upload_kbps ?? '—'}<br>
             <b>Nearest LTE (m):</b> ${p.meters_to_nearest_lte ?? '—'}`
          );
        }
      });

      lteLayer.addTo(map);
      overlays['LTE Towers'] = lteLayer;
      layerControl.addOverlay(lteLayer, 'LTE Towers');
    })
    .catch(err => console.error('Failed to load LTE layer:', err));

  let heatLayer;

  // Convert GeoJSON points to heat array [[lat, lon, weight], ...]
  function geojsonToHeatArray(geojson, weightBy) {
    const pts = [];
    for (const f of geojson.features || []) {
      if (!f.geometry || f.geometry.type !== 'Point') continue;
      const [lon, lat] = f.geometry.coordinates; // GeoJSON is [lon, lat]
      const w = weightBy ? (Number(f.properties?.[weightBy]) || 1) : 1;
      pts.push([lat, lon, w]);
    }
    return pts;
  }

  // Load ALL towers points (use LTE file if you prefer)
  fetch('towers_points.geojson?v=1')
    .then(r => r.json())
    .then(geo => {
      const heatData = geojsonToHeatArray(geo /*, weightBy = null */);
      heatLayer = L.heatLayer(heatData, {
        radius: 18,
        blur: 15,
        maxZoom: 17,
        max: 1.0
      });
      layerControl.addOverlay(heatLayer, 'Heatmap (Towers)');
      // heatLayer.addTo(map); // uncomment to show by default
    })
    .catch(err => console.error('Failed to load towers_points.geojson', err));

  // 4) Tiny legends (bottom-right)
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div style="font-weight:600;margin-bottom:4px;">Choropleth</div>
      <div class="row">
        <span class="swatch" style="background:#08306b"></span>
        <span>All Towers (darker = more)</span>
      </div>
      <div class="row">
        <span class="swatch" style="background:#00441b"></span>
        <span>LTE Towers (darker = more)</span>
      </div>
    `;
    return div;
  };
  legend.addTo(map);

  const heatLegend = L.control({ position: 'bottomright' });
  heatLegend.onAdd = function () {
    const div = L.DomUtil.create('div','info legend');
    const grades = ['low', 'medium', 'high'];
    const colors = ['blue', 'lime', 'red'];  // approximate leaflet.heat gradient
    div.innerHTML = '<b>Heatmap (density)</b><br>';
    for (let i = 0; i < grades.length; i++) {
      div.innerHTML +=
        '<i style="background:' + colors[i] + '"></i> ' +
        grades[i] + '<br>';
    }
    return div;
  };
  heatLegend.addTo(map);
  </script>

  <!-- Visible, clickable credits (extra-safe attribution) -->
  <div class="credits-footer">
    Base map: © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors · OSM data under <a href="https://opendatacommons.org/licenses/odbl/" target="_blank" rel="noopener">ODbL</a>.<br>
    Cell-tower data: <a href="https://opencellid.org/odbl" target="_blank" rel="noopener">OpenCelliD</a> (ODbL).&nbsp;
    Speed data: <a href="https://registry.opendata.aws/speedtest-global-performance/" target="_blank" rel="noopener">Ookla Open Data</a>.
  </div>
</body>
</html>
